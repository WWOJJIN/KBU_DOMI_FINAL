-- 기숙사별 방 정보를 관리하는 테이블 생성
CREATE TABLE IF NOT EXISTS Room_Info (
    room_id INT AUTO_INCREMENT PRIMARY KEY,
    building VARCHAR(20) NOT NULL COMMENT '기숙사 건물명 (양덕원, 숭례원)',
    room_number VARCHAR(10) NOT NULL COMMENT '방 번호',
    room_type VARCHAR(20) DEFAULT '2인실' COMMENT '방 타입 (1인실, 2인실, 3인실 등)',
    max_occupancy INT DEFAULT 2 COMMENT '최대 수용 인원',
    current_occupancy INT DEFAULT 0 COMMENT '현재 입주 인원',
    status ENUM('사용가능', '사용중', '수리중', '사용불가') DEFAULT '사용가능' COMMENT '방 상태',
    floor_number INT COMMENT '층수',
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP,
    
    UNIQUE KEY unique_room (building, room_number),
    INDEX idx_building (building),
    INDEX idx_status (status)
) COMMENT='기숙사 방 정보 관리 테이블';

-- 기본 데이터 삽입 (양덕원 - 50개 방)
INSERT INTO Room_Info (building, room_number, room_type, max_occupancy, floor_number) VALUES
-- 1층 (101~110)
('양덕원', '101', '2인실', 2, 1),
('양덕원', '102', '2인실', 2, 1),
('양덕원', '103', '2인실', 2, 1),
('양덕원', '104', '2인실', 2, 1),
('양덕원', '105', '2인실', 2, 1),
('양덕원', '106', '2인실', 2, 1),
('양덕원', '107', '2인실', 2, 1),
('양덕원', '108', '2인실', 2, 1),
('양덕원', '109', '2인실', 2, 1),
('양덕원', '110', '2인실', 2, 1),

-- 2층 (201~210)
('양덕원', '201', '2인실', 2, 2),
('양덕원', '202', '2인실', 2, 2),
('양덕원', '203', '2인실', 2, 2),
('양덕원', '204', '2인실', 2, 2),
('양덕원', '205', '2인실', 2, 2),
('양덕원', '206', '2인실', 2, 2),
('양덕원', '207', '2인실', 2, 2),
('양덕원', '208', '2인실', 2, 2),
('양덕원', '209', '2인실', 2, 2),
('양덕원', '210', '2인실', 2, 2),

-- 3층 (301~310)
('양덕원', '301', '2인실', 2, 3),
('양덕원', '302', '2인실', 2, 3),
('양덕원', '303', '2인실', 2, 3),
('양덕원', '304', '2인실', 2, 3),
('양덕원', '305', '2인실', 2, 3),
('양덕원', '306', '2인실', 2, 3),
('양덕원', '307', '2인실', 2, 3),
('양덕원', '308', '2인실', 2, 3),
('양덕원', '309', '2인실', 2, 3),
('양덕원', '310', '2인실', 2, 3),

-- 4층 (401~410)
('양덕원', '401', '2인실', 2, 4),
('양덕원', '402', '2인실', 2, 4),
('양덕원', '403', '2인실', 2, 4),
('양덕원', '404', '2인실', 2, 4),
('양덕원', '405', '2인실', 2, 4),
('양덕원', '406', '2인실', 2, 4),
('양덕원', '407', '2인실', 2, 4),
('양덕원', '408', '2인실', 2, 4),
('양덕원', '409', '2인실', 2, 4),
('양덕원', '410', '2인실', 2, 4),

-- 5층 (501~510)
('양덕원', '501', '2인실', 2, 5),
('양덕원', '502', '2인실', 2, 5),
('양덕원', '503', '2인실', 2, 5),
('양덕원', '504', '2인실', 2, 5),
('양덕원', '505', '2인실', 2, 5),
('양덕원', '506', '2인실', 2, 5),
('양덕원', '507', '2인실', 2, 5),
('양덕원', '508', '2인실', 2, 5),
('양덕원', '509', '2인실', 2, 5),
('양덕원', '510', '2인실', 2, 5);

-- 기본 데이터 삽입 (숭례원 - 45개 방)
INSERT INTO Room_Info (building, room_number, room_type, max_occupancy, floor_number) VALUES
-- 1층 (101~109)
('숭례원', '101', '2인실', 2, 1),
('숭례원', '102', '2인실', 2, 1),
('숭례원', '103', '2인실', 2, 1),
('숭례원', '104', '2인실', 2, 1),
('숭례원', '105', '2인실', 2, 1),
('숭례원', '106', '2인실', 2, 1),
('숭례원', '107', '2인실', 2, 1),
('숭례원', '108', '2인실', 2, 1),
('숭례원', '109', '2인실', 2, 1),

-- 2층 (201~209)
('숭례원', '201', '2인실', 2, 2),
('숭례원', '202', '2인실', 2, 2),
('숭례원', '203', '2인실', 2, 2),
('숭례원', '204', '2인실', 2, 2),
('숭례원', '205', '2인실', 2, 2),
('숭례원', '206', '2인실', 2, 2),
('숭례원', '207', '2인실', 2, 2),
('숭례원', '208', '2인실', 2, 2),
('숭례원', '209', '2인실', 2, 2),

-- 3층 (301~309)
('숭례원', '301', '2인실', 2, 3),
('숭례원', '302', '2인실', 2, 3),
('숭례원', '303', '2인실', 2, 3),
('숭례원', '304', '2인실', 2, 3),
('숭례원', '305', '2인실', 2, 3),
('숭례원', '306', '2인실', 2, 3),
('숭례원', '307', '2인실', 2, 3),
('숭례원', '308', '2인실', 2, 3),
('숭례원', '309', '2인실', 2, 3),

-- 4층 (401~409)
('숭례원', '401', '2인실', 2, 4),
('숭례원', '402', '2인실', 2, 4),
('숭례원', '403', '2인실', 2, 4),
('숭례원', '404', '2인실', 2, 4),
('숭례원', '405', '2인실', 2, 4),
('숭례원', '406', '2인실', 2, 4),
('숭례원', '407', '2인실', 2, 4),
('숭례원', '408', '2인실', 2, 4),
('숭례원', '409', '2인실', 2, 4),

-- 5층 (501~509)
('숭례원', '501', '2인실', 2, 5),
('숭례원', '502', '2인실', 2, 5),
('숭례원', '503', '2인실', 2, 5),
('숭례원', '504', '2인실', 2, 5),
('숭례원', '505', '2인실', 2, 5),
('숭례원', '506', '2인실', 2, 5),
('숭례원', '507', '2인실', 2, 5),
('숭례원', '508', '2인실', 2, 5),
('숭례원', '509', '2인실', 2, 5);

-- 현재 입주 인원 업데이트 (실제 Domi_Students 테이블과 동기화)
UPDATE Room_Info ri
SET current_occupancy = (
    SELECT COUNT(*)
    FROM Domi_Students ds
    WHERE ds.dorm_building = ri.building
    AND ds.room_num = ri.room_number
    AND ds.stat = '입주중'
);

-- 방 상태 업데이트 (입주 인원에 따라)
UPDATE Room_Info 
SET status = CASE 
    WHEN current_occupancy = 0 THEN '사용가능'
    WHEN current_occupancy < max_occupancy THEN '사용중'
    WHEN current_occupancy = max_occupancy THEN '사용중'
    ELSE '사용중'
END; 